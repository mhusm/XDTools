<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../observe-js/observe-js.html">
<link rel="import" href="xdmvc.html">

<script>
    Polymer({
        is: "xdmvc-roles",

        properties: {
            roles:{
                type: Object,
                readOnly: true,
                notify: true,
                value: function(){return {selected: [], isselected: {}, othersRoles: {}}}
            },
            available: {
                type: Array,
                value: [],
                observer: "availableChanged",
                notify: true,
                reflectToAttribute: true
            },
            select: {
                type: Array,
                value: [],
                observer: "selectChanged",
                reflectToAttribute: true,
                notify: true
            },
 /*
            selected: {
                type: Array,
                value: [],
                reflectToAttribute: true,
                notify: true
            },
            isselected: {
                type: Object,
                readOnly: true,
                notify: true,
                value: {}
            },
            othersRoles: {
                type: Object,
                readOnly: true,
                notify: true,
                value: XDmvc.othersRoles
            }
  */
        },

        observers: ["updateIsselected(roles.selected.*)"],

        created: function(){
            var that  = this;
            synchronizeArray("roles.selected", XDmvc.roles, this);
            synchronizeObject("roles.othersRoles", XDmvc.othersRoles, this, function(){that.fire("othersRolesChanged")});
        },

        updateIsselected: function() {
            var self = this;
            var r = {};
            Object.keys(this.roles.isselected).forEach(function(role){
                r[role] = false; //default all to false
            });
            this.roles.selected.forEach(function(role) {
                r[role] = true;
            });

            Object.keys(r).forEach(function(role){
                self.set("roles.isselected." +role, r[role]);
            });
            this.fire('isselectedChanged');

        },



        availableChanged: function(){
            var sel = this.roles.isselected;
            if (sel) {
                this.available.forEach(function(r) {
                    // Initialize to false
                    if (!sel[r]) {
                        sel[r] = false;
                    }
                });
            }
        },

        addRole: function(role) {
            XDmvc.addRole(role);
            this.fire('roleChanged')

        },

        removeRole: function(role){
            XDmvc.removeRole(role);
            this.fire('roleChanged')

        },

        selectChanged: function(){
            this.select.forEach(function (r) {
                XDmvc.addRole(r);
           });
        }

    });
</script>
