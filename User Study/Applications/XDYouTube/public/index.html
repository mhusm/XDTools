<!doctype html>
<html>
    <head>
        <script src="http://129.132.173.2/js/remote.js"></script>
        <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
        <link rel="import" href="bower_components/polymer/polymer.html">
        <script src="bower_components/xdmvcclient/js/queryParams.js"></script>
        <script src="js/task2.js"></script>
        <link rel="stylesheet" href="css/task1.css" />
        <link rel="stylesheet" href="css/style.css" />

        <link rel="import" href="bower_components/xdmvcclient/polymer/xdmvc-synchronised.html">
        <link rel="import" href="bower_components/xdmvcclient/polymer/xdmvc-connection.html">
        <link rel="import" href="bower_components/xdmvcclient/polymer/xdmvc-roles.html">
        <link rel="import" href="bower_components/xdmvcclient/polymer/xdmvc-devices.html">
        <link rel="import" href="bower_components/google-youtube/google-youtube.html">
        <link rel="import" href="bower_components/paper-input/paper-input.html">
        <link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
        <link rel="import" href="bower_components/paper-button/paper-button.html">
        <script src="https://code.jquery.com/jquery-git.js"></script>
        <script src="https://apis.google.com/js/client.js"></script>

        <meta name="viewport" content="width=device-width, user-scalable=no">
        <script>
            function initializeYoutubeAPI() {
                gapi.client.setApiKey("AIzaSyDOd1930V0WNcPnmYgM1uXM2NbcYNs7RgI");
                gapi.client.load('youtube', 'v3');
            }

            window.addEventListener("load", initializeYoutubeAPI, false);
        </script>
    </head>
    <body>
        <dom-module id="youtube-app">
            <template>
                <xdmvc-connection reconnect="false" peerport="9005" ajaxport="9006"></xdmvc-connection>
                <xdmvc-synchronised id="sync"
                                    objects='{{synced}}'>
                </xdmvc-synchronised>
                <xdmvc-roles id="roles"
                             available='["player", "controller"]'
                             roles="{{roles}}">
                </xdmvc-roles>
                <xdmvc-devices devices="{{devices}}" id="devices"></xdmvc-devices>
                <template is="dom-if" if="{{roles.isselected.player}}">
                    <div id="yt-div">
                        <template is="dom-if" if="{{synced.current.index}}">
                            <google-youtube
                                    id="yt"
                                    video-id="{{synced.current.index}}"
                                    rel="0"
                                    start="0"
                                    autoplay="1"
                                    fluid
                                    controls="1"
                                    on-google-youtube-state-change="handleStateChange">
                            </google-youtube>
                        </template>
                        <template is="dom-if" if="{{!synced.current.index}}">
                            <google-youtube
                                    id="yt"
                                    video-id=""
                                    rel="0"
                                    start="0"
                                    autoplay="0"
                                    fluid
                                    controls="1"
                                    on-google-youtube-state-change="handleStateChange">
                            </google-youtube>
                        </template>
                    </div>
                </template>
                <template is="dom-if" if="{{roles.isselected.controller}}">
                    <template is="dom-if" if="{{isExtraLargeDevice()}}">
                        <link rel="stylesheet" href="css/extra-large-device.css" />
                    </template>
                    <img src="img/youtube.png" id="youtube-logo" alt="YouTube" />
                    <div id="video-overview">
                        <h3>Current Video</h3>
                        <button id="pauseButton" on-click="pauseClicked">PAUSE</button>
                        <template is="dom-if" if="{{!synced.current.index}}">
                            <div>No video currently playing.</div>
                        </template>
                        <template is="dom-if" if="{{synced.current.index}}">
                            <h4>{{synced.current.title}}</h4>
                            <img class="thumbnail" src="{{synced.current.thumbnail.small}}" alt="" />
                            <div>{{synced.current.description}}</div>
                        </template>
                        <hr />
                        <h3>Queued Videos</h3>
                        <template is="dom-if" if="{{synced.videoQueue}}">
                            <template is="dom-repeat" items="{{synced.videoQueue}}">
                                <div class="queued-video" data-id="{{item.id}}">
                                    <template is="dom-if" if="{{!isLargeDevice()}}">
                                        <img class="thumbnail" src="{{item.thumbnail.small}}" />
                                    </template>
                                    <template is="dom-if" if="{{isLargeDevice()}}">
                                        <style>
                                            .queued-video {
                                                max-width: 330px;
                                            }
                                        </style>
                                        <img class="thumbnail" src="{{item.thumbnail.medium}}" />
                                    </template>
                                    <div>{{item.title}}</div>
                                </div>
                            </template>
                        </template>
                        <template is="dom-if" if="{{!synced.videoQueue}}">
                            No queued videos.
                        </template>
                    </div>
                    <div id="search-panel">
                        <paper-input label="Search video" id="query" value="{{searchTerm}}" on-keypress="inputKeyPressed" floatingLabel></paper-input>
                        <paper-button id="searchButton" on-click="searchVideo" raised>Search</paper-button>
                        <div>
                            <div id="results">
                                <template is="dom-repeat" items="{{searchResult}}">
                                    <div class="video" data-id="{{item.id}}">
                                        <paper-dialog>
                                        <h4>{{item.title}}</h4>
                                        <template is="dom-if" if="{{!isLargeDevice()}}">
                                            <img class="thumbnail" src="{{item.thumbnail.small}}" />
                                        </template>
                                        <template is="dom-if" if="{{isLargeDevice()}}">
                                            <style>
                                                .queued-video {
                                                    max-width: 330px;
                                                }
                                            </style>
                                            <img class="thumbnail" src="{{item.thumbnail.medium}}" />
                                        </template>
                                        <div>{{item.description}}</div>
                                        <paper-button on-click="addToQueue" raised>Add to Queue</paper-button>
                                        </paper-dialog>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <template is="dom-if" if="{{searched}}">
                            <div id="search-navigation">
                                <paper-button class="navigation" on-click="getPreviousPage" raised><</paper-button>
                                <paper-button class="navigation" on-click="getNextPage" raised>></paper-button>
                            </div>
                        </template>
                    </div>
                </template>
            </template>
        </dom-module>
        <script>

            Polymer({
                is: "youtube-app",

                properties: {
                    synced: {
                        type: Object,
                        value: {"current": { "index": "", "title": "", "thumbnail": {"small": "", "medium": ""}, "description": ""}, "videoQueue": [], "paused": {"state": false}},
                        notify: true
                    },
                    searchResult: {
                        type: Array,
                        value: [],
                        notify: true
                    },
                    searched: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },
                    previousPageToken: {
                        type: String,
                        value: "",
                        notify: true
                    },
                    nextPageToken: {
                        type: String,
                        value: "",
                        notify: true
                    }
                },

                makeSingleDevice: function () {
                    alert("hi");
                },

                isOnlyDevice: function () {
                    return XDmvc.othersDevices.small === 0 && XDmvc.othersDevices.medium === 0 && XDmvc.othersDevices.large === 0 && XDmvc.othersDevices.xlarge === 0;
                },

                isLargeDevice: function () {
                    return this.$.devices.devices.thisDevice.width > 1000;
                    //return this.$.devices.devices.thisDevice.type === "large" || this.$.devices.devices.thisDevice.type === "xlarge";
                },

                isExtraLargeDevice: function () {
                    return this.$.devices.devices.thisDevice.type === "xlarge"
                },

                inputKeyPressed: function (ev) {
                    if (ev.which === 13) {
                        var button = document.getElementById("searchButton");
                        button.click();
                    }
                },

                contained: function(id) {
                    return this.synced.videoQueue.indexOf(id) !== -1;
                },

                pauseVideo: function () {
                    document.getElementsByTagName("google-youtube")[0].pause();
                },

                isVideoPlaying: function () {
                    if (this.synced.current.index) {
                        return true;
                    }
                    else {
                        return false;
                    }
                },

                setPausedState: function (state) {
                    this.synced.paused.state = state;
                },

                getPausedState: function () {
                    return this.synced.paused.state;
                },

                unpauseVideo: function () {
                    document.getElementsByTagName("google-youtube")[0].play();
                },

                isPlayer: function () {
                    return XDmvc.roles.indexOf("player") !== -1;
                },

                isController: function () {
                    return XDmvc.roles.indexOf("controller") !== -1;
                },

                updateVideo: function () {
                    //TODO: Comment out for study and uncomment updateVideo(this)
                    if (this.synced.videoQueue.length > 0) {
                        var next = this.shift("synced.videoQueue");
                        this.set("synced.current.index", next.id);
                        this.set("synced.current.title", next.title);
                        this.set("synced.current.thumbnail.small", next.thumbnail.small);
                        this.set("synced.current.thumbnail.medium", next.thumbnail.medium);
                        this.set("synced.current.description", next.description);
                    }
                    else {
                        this.set("synced.current.index", "");
                    }
                    //updateVideo(this);
                },

                handleStateChange: function (ev) {
                    //TODO: should be ev.data === YT.PlayerState.ENDED, but that does not work
                    if (ev.detail.data === 0) {
                        this.updateVideo();
                    }
                    else if (ev.detail.data === 2) {
                        this.synced.paused.state = true;
                    }
                    else if (ev.detail.data === 1) {
                        this.synced.paused.state = false;
                    }
                },

                pauseClicked: function () {
                    pauseClicked(this);
                    /*
                    if (this.isVideoPlaying()) {
                        this.setPausedState(!this.getPausedState());
                    }
                    */
                },

                updatePaused: function () {
                    updatePaused(this);
                    /*
                    if (this.isPlayer()) {
                        if (this.getPausedState()) {
                            this.pauseVideo();
                        }
                        else {
                            this.unpauseVideo();
                        }
                    }
                    if (this.isController()) {
                        if (this.getPausedState()) {
                            document.getElementById("pauseButton").textContent = "PLAY";
                        }
                        else {
                            document.getElementById("pauseButton").textContent = "PAUSE";
                        }
                    }
                    */
                },

                searchVideo: function (pageToken) {
                    var q = this.searchTerm,
                        request = {};
                    if (typeof(pageToken) === 'string' || pageToken instanceof String) {
                        request = gapi.client.youtube.search.list({
                            q: q,
                            part: "snippet",
                            type: "video",
                            maxResults: 10,
                            pageToken: pageToken
                        });
                    }
                    else {
                        this.previousPageToken = "";
                        this.nextPageToken = "";
                        request = gapi.client.youtube.search.list({
                            q: q,
                            part: "snippet",
                            type: "video",
                            maxResults: 10
                        })
                    }

                    var that = this;

                    request.execute(function (response) {
                        var result = response.items,
                                videos = [];
                        for (var i = 0, j = result.length; i < j; ++i) {
                            videos.push({
                                "id": result[i].id.videoId,
                                "title": result[i].snippet.title,
                                "description": result[i].snippet.description,
                                "thumbnail": {"small": result[i].snippet.thumbnails.default.url, "medium": result[i].snippet.thumbnails.medium.url}
                            });
                        }
                        that.set("searchResult", videos);
                        that.set("searched", true);
                        if (response.nextPageToken) {
                            that.nextPageToken = response.nextPageToken;
                        }
                        else {
                            //disable next button
                        }
                        if (response.prevPageToken) {
                            that.previousPageToken = response.prevPageToken;
                        }
                        else {
                            //disable previous button
                        }
                        var resultEl = document.getElementById("results");
                        resultEl.scrollTop = 0;
                    });
                },

                getNextPage: function () {
                    if (this.nextPageToken) {
                        this.searchVideo(this.nextPageToken);
                    }
                },

                getPreviousPage: function () {
                    if (this.previousPageToken) {
                        this.searchVideo(this.previousPageToken);
                    }
                },

                addToQueue: function (ev) {
                    var id = $(ev.target).closest(".video")[0].dataId;
                    var index = this.searchResult.map(function (e) { return e.id; }).indexOf(id);
                    if (this.synced.videoQueue.length === 0 && this.synced.current.index === "") {
                        this.set("synced.current.index", this.searchResult[index].id);
                        this.set("synced.current.title", this.searchResult[index].title);
                        this.set("synced.current.thumbnail.small", this.searchResult[index].thumbnail.small);
                        this.set("synced.current.thumbnail.medium", this.searchResult[index].thumbnail.medium);
                        this.set("synced.current.description", this.searchResult[index].description);
                    }
                    else {
                        this.push("synced.videoQueue", {"id": id, "title": this.searchResult[index].title, "thumbnail": this.searchResult[index].thumbnail, "description": this.searchResult[index].description});
                    }
                },

                updateViews: function () {
                    if (this.$.devices.devices.connectedDevices.length === 0) {
                        this.$.roles.addRole('player');
                        this.$.roles.addRole('controller');
                        var el = document.getElementById("yt-div");
                        if (el) {
                            el.setAttribute("style", "");
                        }
                        document.body.setAttribute("style", "");
                    }
                    else {
                        var largest = true;
                        for (var i = 0, j = this.$.devices.devices.connectedDevices.length; i < j; ++i) {
                            if (this.$.devices.devices.connectedDevices[i].device.width > this.$.devices.devices.thisDevice.width) {
                                largest = false;
                            }
                            else if (this.$.devices.devices.connectedDevices[i].device.width === this.$.devices.devices.thisDevice.width) {
                                var id = parseInt(XDmvc.deviceId.substring(2));
                                var otherId = parseInt(this.$.devices.devices.connectedDevices[i].id.substring(2));
                                if (id > otherId) {
                                    largest = false;
                                }
                            }
                        }
                        if (largest) {
                            this.$.roles.addRole("player");
                            this.$.roles.removeRole("controller");
                        }
                        else {
                            this.$.roles.addRole("controller");
                            this.$.roles.removeRole("player");
                        }
                        var el = document.getElementById("yt-div");
                        if (el) {
                            el.setAttribute("style", "background-color: black; width: 100%; height: 100%;");
                        }
                        document.body.setAttribute("style", "margin: 0;");
                    }
                },

                ready: function () {

                    var connect = getQueryParams(window.location.search).connect;
                    if (!connect) {
                        var connectString = 'connect=' + XDmvc.deviceId;
                        window.history.pushState('', '', window.location.search.length > 0 ? window.location.search + "&" + connectString : '?' + connectString);
                        this.$.roles.addRole('player');
                        this.$.roles.addRole('controller');
                    } else {
                        if (connect !== XDmvc.deviceId) {
                            if (XDmvc.server) {
                                XDmvc.connectTo(getQueryParams(window.location.search).connect);
                            } else { // not yet connected to server, wait for the connection event
                                document.addEventListener("XDServer", function(){
                                    XDmvc.connectTo(getQueryParams(window.location.search).connect);
                                });
                            }
                            this.$.roles.addRole('controller');
                        } else {
                            this.$.roles.addRole('player');
                            this.$.roles.addRole('controller');
                        }
                    }

                    var that = this;

                    var observer = new ObjectObserver(this.$.devices.devices.othersDevices);
                    observer.open(function(changes){
                        that.updateViews();
                    });

                    var observer2 = new ObjectObserver(this.synced.paused);
                    observer2.open(function (changes) {
                       that.updatePaused();
                    });
                }

            });
        </script>


        <youtube-app id="app"></youtube-app>

    </body>
</html>