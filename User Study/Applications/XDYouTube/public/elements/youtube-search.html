<link rel="import" href="../bower_components/polymer/polymer.html">
<dom-module id="youtube-search">
    <div id="search-panel">
        <paper-input label="Search video" id="query" value="{{searchTerm}}" on-keypress="inputKeyPressed" floatingLabel></paper-input>
        <paper-button id="searchButton" on-click="searchVideo" raised>Search</paper-button>
        <div>
            <div id="results">
                <template is="dom-repeat" items="{{searchResult}}">
                    <div class="video" data-id="{{item.id}}">
                        <h4>{{item.title}}</h4>
                        <template is="dom-if" if="{{!isLargeDevice()}}">
                            <img class="thumbnail" src="{{item.thumbnail.small}}" />
                        </template>
                        <template is="dom-if" if="{{isLargeDevice()}}">
                            <style>
                                .queued-video {
                                    max-width: 330px;
                                }
                            </style>
                            <img class="thumbnail" src="{{item.thumbnail.medium}}" />
                        </template>
                        <span>{{item.description}}</span>
                        <br />
                        <paper-button on-click="addToQueue" raised>Add to Queue</paper-button>
                        <hr />
                    </div>
                </template>
            </div>
        </div>
        <paper-button on-click="getPreviousPage" raised><</paper-button>
        <paper-button on-click="getNextPage" raised>></paper-button>
    </div>
</dom-module>
<script>
    Polymer({
        is: "youtube-search",

        properties: {
            synced: {
                type: Object,
                value: {"current": { "index": "", "title": "", "thumbnail": {"small": "", "medium": ""}, "description": ""}, "videoQueue": []},
                notify: true
            },
            searchResult: {
                type: Array,
                value: [],
                notify: true
            },
            previousPageToken: {
                type: String,
                value: "",
                notify: true
            },
            nextPageToken: {
                type: String,
                value: "",
                notify: true
            }
        },

        inputKeyPressed: function (ev) {
            if (ev.which === 13) {
                var button = document.getElementById("searchButton");
                button.click();
            }
        },

        searchVideo: function (pageToken) {
            var q = this.searchTerm,
                    request = {};
            if (typeof(pageToken) === 'string' || pageToken instanceof String) {
                request = gapi.client.youtube.search.list({
                    q: q,
                    part: "snippet",
                    type: "video",
                    maxResults: 10,
                    pageToken: pageToken
                });
            }
            else {
                this.previousPageToken = "";
                this.nextPageToken = "";
                request = gapi.client.youtube.search.list({
                    q: q,
                    part: "snippet",
                    type: "video",
                    maxResults: 10
                })
            }

            request.execute(function (response) {
                var result = response.items,
                        videos = [];
                for (var i = 0, j = result.length; i < j; ++i) {
                    videos.push({
                        "id": result[i].id.videoId,
                        "title": result[i].snippet.title,
                        "description": result[i].snippet.description,
                        "thumbnail": {"small": result[i].snippet.thumbnails.default.url, "medium": result[i].snippet.thumbnails.medium.url}
                    });
                }
                var el = document.getElementById("app");
                el.searchResult = videos;
                if (response.nextPageToken) {
                    el.nextPageToken = response.nextPageToken;
                }
                else {
                    //disable next button
                }
                if (response.prevPageToken) {
                    el.previousPageToken = response.prevPageToken;
                }
                else {
                    //disable previous button
                }
                var resultEl = document.getElementById("results");
                resultEl.scrollTop = 0;
            });
        },

        getNextPage: function () {
            if (this.nextPageToken) {
                this.searchVideo(this.nextPageToken);
            }
        },

        getPreviousPage: function () {
            if (this.previousPageToken) {
                this.searchVideo(this.previousPageToken);
            }
        },

        addToQueue: function (ev) {
            var id = $(ev.target).closest(".video")[0].dataId;
            var index = this.searchResult.map(function (e) { return e.id; }).indexOf(id);
            if (this.synced.videoQueue.length === 0 && this.synced.current.index === "") {
                this.set("synced.current.index", this.searchResult[index].id);
                this.set("synced.current.title", this.searchResult[index].title);
                this.set("synced.current.thumbnail.small", this.searchResult[index].thumbnail.small);
                this.set("synced.current.thumbnail.medium", this.searchResult[index].thumbnail.medium);
                this.set("synced.current.description", this.searchResult[index].description);
            }
            else {
                this.push("synced.videoQueue", {"id": id, "title": this.searchResult[index].title, "thumbnail": this.searchResult[index].thumbnail, "description": this.searchResult[index].description});
            }
        }

    });
</script>

