<link rel="import" href="../../polymer/polymer.html">
<polymer-element name="role-element" attributes="roles selected isselected" >
    <template>
        <h2>My roles</h2>
        <ul>
			<template repeat="{{r in roles }}" bind="{{selected}}">
				<label><input on-change="{{selectionChanged}}" type="checkbox" checked="{{isselected[r]}}"></input>{{r}}</label>
			</template>
        
        </ul>
    </template>
	<script>
		Polymer('role-element', {
			created: function() {
                this.roles = [];
                this.selected = [];
                this.isselected = {};
            },
            
            ready: function(){
                XDmvc.roles = this.selected;
                var self = this;
                Object.observe(XDmvc.roles, function(changes){
                    self.updateIsselected();
                });
            },
            
            updateIsselected: function() {
                var self = this;
                this.roles.forEach(function(r) {
                    self.isselected[r] = self.selected.indexOf(r) > -1;
                });
            },
            
            
            selectionChanged: function(event, detail, sender){
                var role = sender.templateInstance.model.r;
                if (sender.checked) {
                    this.addRole(role)
                } else {
                    this.removeRole(role);
                }
            },
            
           rolesChanged: function(e){
                var sel = this.isselected;
                this.roles.forEach(function(r) {
                    // Initialize to false
                    if (!sel[r]) {
                        sel[r] = false;
                    }
                });
            },
            
            addRole: function(role) {
                XDmvc.addRole(role);
                this.fire('roleChanged')
               
            },
            
            removeRole: function(role){
                XDmvc.removeRole(role);
                this.fire('roleChanged')
          
            },
  
            selectedChanged: function(){
                var sel = this.isselected;
                this.selected.forEach(function(r) {
                    XDmvc.addRole(r);
                    if (!sel[r]) {
                        sel[r] = true;
                    }
                });
             }
 	  
		});
	</script>
</polymer-element>