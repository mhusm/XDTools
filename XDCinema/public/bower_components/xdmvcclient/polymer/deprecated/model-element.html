<link rel="import" href="../../polymer/polymer.html">
<polymer-element name="model-element" attributes="persistent transient url" >
	<script>
		Polymer('model-element', {
            created: function() {
                this.persistent = {};
                this.transient = {};
            },
            
           attached: function() {
                XDmvc.synchronize(this.persistent, undefined, "persistent");
                XDmvc.synchronize(this.transient, undefined, "transient");
                var thisPersistent = this.persistent;
                var thisTransient = this.transient;
                var thisElement = this;
                var observe = function(changes){
                    console.log("sending persistent changes to server");
                    console.log(thisPersistent);
					jQuery.ajax ({
						url: thisElement.url,
						type: "POST",
						data: JSON.stringify({"changed" : thisPersistent}),
						dataType: "json",
						contentType: "application/json; charset=utf-8",
						success: function(){
							//
						}
					});
	/*				
                    $.post(thisElement.url, {"changed" : thisPersistent},
                        function (data) {
          //                  XDmvc.loadNew(thisPersistent, data.persistent, "persistent");
                       }, 
					   "application/json; charset=utf-8"
                    );
*/      
				};
				

                // TODO should only be sent to server, when change is local, and not when received form peer or server
                Object.observe(thisPersistent, observe);
               
               // TODO remove jquery
                $.getJSON(thisElement.url,
                    function (data) {
                        Object.unobserve(thisPersistent, observe);
                        XDmvc.loadNew(thisPersistent, data.persistent, "persistent");
                        XDmvc.loadNew(thisTransient, data.transient, "transient");
                        Object.observe(thisPersistent, observe);
                        console.log(thisTransient);
                });
            
                  
			}
	  
		});
	</script>
</polymer-element>